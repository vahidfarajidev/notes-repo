# ููุงูู ฺฉุงูู: Lazy Evaluation ุฏุฑ C# ู ฺฉุงุฑุจุฑุฏ ุขู ุฏุฑ ุฏุชุงุจุณ

## ุจุฎุด ุงูู: Lazy Evaluation ฺุณุชุ

### ุชุนุฑู ุณุงุฏู

**Lazy Evaluation (ูุญุงุณุจู ุชูุจู)** ุนู:
> ูุญุงุณุจู ุง ุชููุฏ ุฏุงุฏู ููุท ููุช ุงูุฌุงู ุดูุฏ ฺฉู ูุงูุนุงู ุจู ูุชุฌู ูุงุฒ ุฏุงุฑูุ ูู ูุจู ุงุฒ ุขู.

**Eager Evaluation** ุจุฑุนฺฉุณ ุงุณุช:
> ููู ฺุฒ ููุฑุงู ูุญุงุณุจู ู ุฏุฑ ุญุงูุธู ุฐุฎุฑู ูโุดูุฏ.

## ุจุฎุด ุฏูู: Lazy ุฏุฑ C# ุจุง `IEnumerable` ู `yield return`

### ูุซุงู ูพุงู
```csharp
IEnumerable<int> Squares(int n)
{
    for (int i = 1; i <= n; i++)
        yield return i * i;
}
```
ูููุฒ ูฺ ุนุฏุฏ ูุญุงุณุจู ูุดุฏู ุงุณุช! ููุท ฺฉ **iterator** ุณุงุฎุชู ุดุฏู ุงุณุช.

### ูุตุฑู ุญุงูุธู ู ุงุฌุฑุง
```csharp
foreach(var x in Squares(5))
{
    Console.WriteLine(x);
}
```
* ูุฑ ุนูุตุฑ ููุท ููุช ููุฑุฏ ูุงุฒ ุงุณุช ูุญุงุณุจู ูโุดูุฏ.
* ูุฑุญูู ุจู ูุฑุญูู:

| Iteration | ููุฏุงุฑ ูุญุงุณุจู ุดุฏู | ุฏุฑ ุญุงูุธู ูุนู |
| --------- | ---------------- | ------------- |
| 1         | 1                | 1             |
| 2         | 4                | 4 (1 ุขุฒุงุฏ ุดุฏ) |
| 3         | 9                | 9 (4 ุขุฒุงุฏ ุดุฏ) |
| โฆ         | โฆ                | โฆ             |

โ **ููุท ฺฉ ุนูุตุฑ ุฏุฑ ุญุงูุธู ุงุณุช** ู ฺฉู ูุฌููุนู ุฐุฎุฑู ููโุดูุฏ.

## ุจุฎุด ุณูู: ุจุฏูู `yield return` ฺู ูโุดูุฏุ

```csharp
IEnumerable<int> Squares(int n)
{
    var list = new List<int>();
    for (int i = 1; i <= n; i++)
        list.Add(i * i);
    return list;
}
```

| ูฺฺฏ              | ุจุง `yield return`  | ุจุฏูู `yield return`      |
| ------------------ | ------------------ | ------------------------ |
| ุฒูุงู ูุญุงุณุจู        | Lazy               | Eager                    |
| ูุตุฑู ุญุงูุธู         | ฺฉ ุนูุตุฑ ุฏุฑ ูุฑ ูุญุธู | ููู ุนูุงุตุฑ ุฏุฑ ุญุงูุธู       |
| ููุงุณุจ ุฏุงุฏู ุจุฒุฑฺฏ    | โ                  | โ                        |
| ุฌุฑุงู ุฏุงุฏู         | ูุฑุญููโุง           | ฺฉู ุนูุงุตุฑ ุขูุงุฏู ุฏุฑ ุญุงูุธู  |
| ุงูฺฉุงู ูุทุน ุฒูุฏููฺฏุงู | โ                  | โ (ููู ุนูุงุตุฑ ูุญุงุณุจู ุดุฏู) |

๐ก **ูุซุงู ุนูู:**
```csharp
foreach(var x in Squares(1000000))
{
    if (x > 10) break;
    Console.WriteLine(x);
}
```
* ุจุง `yield`: ุชููุง 10 ุนูุตุฑ ูุญุงุณุจู ูโุดููุฏ
* ุจุฏูู `yield`: ฺฉ ูููู ุนูุตุฑ ุฏุฑ ุญุงูุธู ุณุงุฎุชู ูโุดููุฏ โ ูุตุฑู ุจุงูุง

## ุจุฎุด ฺูุงุฑู: ุชูุงูุช List ู IEnumerable

* **List / IList** โ ููู ุนูุงุตุฑ Eager ุฏุฑ ุญุงูุธู ูุณุชูุฏ
* **IEnumerable ุจุง yield** โ ุนูุงุตุฑ Lazyุ ูุตุฑู ุญุงูุธู ฺฉูุ ููุงุณุจ ุฏุงุฏู ุจุฒุฑฺฏ

## ุจุฎุด ูพูุฌู: ูุฑูุฏ ุจู ุฏูุง ุฏุชุงุจุณ

```csharp
dbContext.Orders
```
* ููุน: `DbSet<Order>` โ `IQueryable<Order>`

### ุงุฌุฑุง query
```csharp
var query = dbContext.Orders.Where(o => o.Amount > 1000);
```
* ูููุฒ ูฺ SQL ุงุฌุฑุง ูุดุฏู
* ููุท ฺฉ **Expression Tree** ุณุงุฎุชู ุดุฏู ุงุณุช

### ููุช `foreach` ุงุฌุฑุง ุดูุฏ
```csharp
foreach(var order in query)
{
    Console.WriteLine(order.Id);
}
```
* EF SQL ูโุณุงุฒุฏ:
```sql
SELECT * FROM Orders WHERE Amount > 1000;
```
* ุฏุชุงุจุณ ูุชุงุฌ ุฑุง **stream** ูโฺฉูุฏ ู EF ฺฉโุจูโฺฉ ุฑฺฉูุฑุฏ ุฑุง ุจู entity ุชุจุฏู ูโฺฉูุฏ.
* ฺฉู ุฏุงุฏูโูุง ููุฒูุงู ุฏุฑ ุญุงูุธู client ูุณุชูุฏ.

### ุชุตูุฑ ูุฑุญููโุง ูุตุฑู ุญุงูุธู

| ูุฑุญูู | ุฏุชุงุจุณ         | ุญุงูุธู Client                |
| ----- | --------------- | --------------------------- |
| 1     | query ุณุงุฎุชู ุดุฏู | iterator ุขูุงุฏู              |
| 2     | row1 ุงุฑุณุงู ุดุฏ   | row1 entity ุณุงุฎุชู ุดุฏ        |
| 3     | row2 ุงุฑุณุงู ุดุฏ   | row2 ุณุงุฎุชู ุดุฏ, row1 ุขุฒุงุฏ ุดุฏ |
| 4     | row3 ุงุฑุณุงู ุดุฏ   | row3 ุณุงุฎุชู ุดุฏ, row2 ุขุฒุงุฏ ุดุฏ |

## ุจุฎุด ุดุดู: ุชูุงูุช IQueryable ู IEnumerable ุฏุฑ ุฏุชุงุจุณ

| ุญุงูุช                 | ุงุฌุฑุง            | ุฏุงุฏูโูุง              | Lazy evaluation |
| -------------------- | --------------- | -------------------- | --------------- |
| IQueryable (foreach) | ูู ุชุง enumerate | ุฏุชุงุจุณ stream       | ุจููุ ุฑู server |
| AsEnumerable()       | ุจูู             | ฺฉู ุฏุงุฏูโูุง ุจู client | ุจููุ ุฑู client |
| ToList()             | ุจูู             | ฺฉู ุฏุงุฏูโูุง ุจู client | ููุ ููู eager   |

## ุจุฎุด ููุชู: ูุฒุงุง ู ูุญุฏูุฏุชโูุง ุงุณุชูุงุฏู ุงุฒ IQueryable

**ูุฒุงุง:**

* Lazy execution ุฑู server
* SQL ุจููู ุชููุฏ ูโุดูุฏ
* ูพุฑุฏุงุฒุด ูุฑุญููโุง ู ูุตุฑู ฺฉู ุญุงูุธู

**ูุญุฏูุฏุชโูุง:**

* ุชูุงุจุน ูพฺุฏู C# ุฑุง ููโุชูุงูุฏ ุจู SQL ุชุฑุฌูู ฺฉูุฏ
* ูุฑ enumerate ูโุชูุงูุฏ SQL ุฌุฏุงฺฏุงูู ุงุฌุฑุง ฺฉูุฏ
* ุงุชุตุงู ุจู ุฏุชุงุจุณ ุจุงุฏ ุฏุฑ ุทูู iteration ุจุฑูุฑุงุฑ ุจุงุดุฏ

## ุจุฎุด ูุดุชู: ุชุตููโฺฏุฑ ุจุฑุง ุงุณุชูุงุฏู

| ุณูุงุฑู                       | ูพุดููุงุฏ        |
| ---------------------------- | -------------- |
| ุฏุงุฏู ุจุฒุฑฺฏ ู ฺฉุจุงุฑ ูพุฑุฏุงุฒุด     | IQueryable     |
| ฺูุฏ ุจุงุฑ ุงุณุชูุงุฏู ุง cache     | ToList()       |
| ูุงุฒ ุจู ูพุฑุฏุงุฒุด C# ุฑู client | AsEnumerable() |

โ **ุฌูุนโุจูุฏ ููุง**

* Lazy Evaluation = ุงุฌุฑุง ูุฑุญููโุง ููุท ููุช ุฏุงุฏู ูุงุฒ ุงุณุช
* `IEnumerable` ุจุง `yield` โ Lazy ุฏุฑ ุญุงูุธู client
* `IQueryable` โ Lazy ุฑู serverุ SQL ุชููุง ุฒูุงู ุงุฌุฑุง ูโุดูุฏ ฺฉู ุฏุงุฏู ูุตุฑู ุดูุฏ
* ุจุฏูู `yield` โ ุชุงุจุน Eager ูโุดูุฏุ ููู ุนูุงุตุฑ ฺฉุฌุง ูุญุงุณุจู ู ุฏุฑ ุญุงูุธู ูุฑุงุฑ ูโฺฏุฑูุฏ
